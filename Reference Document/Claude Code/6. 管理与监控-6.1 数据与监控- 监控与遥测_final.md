---
title: "Claude Code 监控与遥测完全指南：OpenTelemetry 集成详解"
description: "学习如何为 Claude Code 配置 OpenTelemetry 监控，包括环境变量设置、指标导出、事件追踪，以及企业级多团队遥测解决方案。"
date: "2026-02-10"
tool: "Claude Code"
---

import AdPlaceholder from '@/components/AdPlaceholder'

# Claude Code 监控与遥测完全指南

Claude Code 支持 OpenTelemetry（OTel）指标和事件导出，为组织提供强大的监控和可观测性能力。通过配置遥测系统，您可以跟踪使用模式、监控成本、分析性能瓶颈，并生成有价值的运营洞察。所有指标都通过 OpenTelemetry 的标准指标协议导出为时间序列数据，事件则通过日志协议导出，让您可以灵活地集成到现有的监控基础设施中。

<AdPlaceholder />

## 前置条件

在配置监控之前，请确保满足以下条件：

- 理解 OpenTelemetry 的基本概念
- 具备命令行操作和环境变量配置经验
- 了解监控后端（如 Prometheus、Datadog）的使用方法
- 对于企业部署，需要具备管理员权限

## 快速开始

### 启用遥测

使用环境变量配置 OpenTelemetry，首先启用遥测收集：

```bash
export CLAUDE_CODE_ENABLE_TELEMETRY=1
```

### 选择导出器

根据您的监控基础设施选择合适的导出器类型：

```bash
# 选项：otlp、prometheus、console
export OTEL_METRICS_EXPORTER=otlp
export OTEL_LOGS_EXPORTER=otlp
```

### 配置 OTLP 端点

为 OTLP 导出器配置端点信息：

```bash
export OTEL_EXPORTER_OTLP_PROTOCOL=grpc
export OTEL_EXPORTER_OTLP_ENDPOINT=http://localhost:4317
```

### 设置身份验证

如需要，配置身份验证标头：

```bash
export OTEL_EXPORTER_OTLP_HEADERS="Authorization=Bearer your-token"
```

### 调试配置

在设置期间，可以使用更短的导出间隔进行调试：

```bash
export OTEL_METRIC_EXPORT_INTERVAL=10000  # 10 秒（默认：60000ms）
export OTEL_LOGS_EXPORT_INTERVAL=5000     # 5 秒（默认：5000ms）
```

<AdPlaceholder />

## 配置详情

### 核心环境变量

| 环境变量 | 描述 | 示例值 |
|----------|------|--------|
| `CLAUDE_CODE_ENABLE_TELEMETRY` | 启用遥测收集（必需） | `1` |
| `OTEL_METRICS_EXPORTER` | 指标导出器类型 | `console`、`otlp`、`prometheus` |
| `OTEL_LOGS_EXPORTER` | 日志导出器类型 | `console`、`otlp` |
| `OTEL_EXPORTER_OTLP_PROTOCOL` | OTLP 协议 | `grpc`、`http/json`、`http/protobuf` |
| `OTEL_EXPORTER_OTLP_ENDPOINT` | OTLP 收集器端点 | `http://localhost:4317` |
| `OTEL_EXPORTER_OTLP_HEADERS` | OTLP 身份验证标头 | `Authorization=Bearer token` |
| `OTEL_METRIC_EXPORT_INTERVAL` | 导出间隔（毫秒） | `5000`、`60000` |
| `OTEL_LOGS_EXPORT_INTERVAL` | 日志导出间隔（毫秒） | `1000`、`10000` |

### 协议和端点配置

支持为指标和日志分别配置不同的端点和协议：

```bash
# 指标和日志使用不同的后端
export OTEL_EXPORTER_OTLP_METRICS_PROTOCOL=http/protobuf
export OTEL_EXPORTER_OTLP_METRICS_ENDPOINT=http://metrics.company.com:4318
export OTEL_EXPORTER_OTLP_LOGS_PROTOCOL=grpc
export OTEL_EXPORTER_OTLP_LOGS_ENDPOINT=http://logs.company.com:4317
```

### mTLS 身份验证

对于需要双向 TLS 身份验证的企业环境：

```bash
export OTEL_EXPORTER_OTLP_METRICS_CLIENT_KEY=/path/to/client.key
export OTEL_EXPORTER_OTLP_METRICS_CLIENT_CERTIFICATE=/path/to/client.crt
```

<AdPlaceholder />

## 管理员配置

### 托管设置

管理员可以通过托管设置文件为所有用户集中配置 OpenTelemetry。这允许在整个组织中统一遥测设置，确保一致的数据收集策略。

### 配置示例

```json
{
  "env": {
    "CLAUDE_CODE_ENABLE_TELEMETRY": "1",
    "OTEL_METRICS_EXPORTER": "otlp",
    "OTEL_LOGS_EXPORTER": "otlp",
    "OTEL_EXPORTER_OTLP_PROTOCOL": "grpc",
    "OTEL_EXPORTER_OTLP_ENDPOINT": "http://collector.company.com:4317",
    "OTEL_EXPORTER_OTLP_HEADERS": "Authorization=Bearer company-token"
  }
}
```

### 优先级说明

在托管设置文件中定义的环境变量具有高优先级，用户无法覆盖。这确保了组织级别的安全策略和合规要求得到执行。

<AdPlaceholder />

## 指标基数控制

### 控制属性

以下环境变量控制指标中包含哪些属性以管理基数：

| 环境变量 | 描述 | 默认值 | 禁用示例 |
|----------|------|--------|----------|
| `OTEL_METRICS_INCLUDE_SESSION_ID` | 包含 session.id 属性 | `true` | `false` |
| `OTEL_METRICS_INCLUDE_VERSION` | 包含 app.version 属性 | `false` | `true` |
| `OTEL_METRICS_INCLUDE_ACCOUNT_UUID` | 包含 user.account_uuid 属性 | `true` | `false` |

### 基数权衡

较低的基数意味着更好的性能和更低的存储成本，但会降低数据分析的粒度。根据实际需求和监控后端能力选择合适的配置。

<AdPlaceholder />

## 可用指标

### 标准属性

所有指标和事件共享这些标准属性：

| 属性 | 描述 | 控制方式 |
|------|------|----------|
| `session.id` | 唯一会话标识符 | `OTEL_METRICS_INCLUDE_SESSION_ID` |
| `app.version` | Claude Code 版本 | `OTEL_METRICS_INCLUDE_VERSION` |
| `organization.id` | 组织 UUID | 始终包含（已认证时） |
| `user.account_uuid` | 账户 UUID | `OTEL_METRICS_INCLUDE_ACCOUNT_UUID` |
| `terminal.type` | 终端类型 | 始终包含（检测到时） |

### 核心指标

| 指标名称 | 描述 | 单位 |
|----------|------|------|
| `claude_code.session.count` | 启动的 CLI 会话计数 | count |
| `claude_code.lines_of_code.count` | 修改的代码行数 | count |
| `claude_code.pull_request.count` | 创建的拉取请求数 | count |
| `claude_code.commit.count` | 创建的 git 提交数 | count |
| `claude_code.cost.usage` | Claude Code 会话成本 | USD |
| `claude_code.token.usage` | 使用的令牌数 | tokens |
| `claude_code.code_edit_tool.decision` | 代码编辑工具权限决策计数 | count |
| `claude_code.active_time.total` | 总活跃时间 | s |

### 指标详情

**会话计数器**：在每个会话开始时递增，跟踪整体使用趋势。

**代码行计数器**：当添加或删除代码时递增，具有 `type` 属性标识操作类型（`added` 或 `removed`）。

**成本计数器**：在每个 API 请求后递增，包含 `model` 属性标识使用的模型。

**令牌计数器**：在每个 API 请求后递增，`type` 属性区分输入、输出、缓存读取和缓存创建令牌。

**活跃时间计数器**：跟踪实际积极使用 Claude Code 的时间（排除空闲时间），在用户交互时递增。

<AdPlaceholder />

## 事件追踪

### 用户提示事件

记录用户提交提示的时刻。

**事件名称**：`claude_code.user_prompt`

**属性**：`prompt_length` 记录提示长度，`prompt` 记录完整内容（需启用 `OTEL_LOG_USER_PROMPTS=1`）。

### 工具结果事件

记录工具完成执行时的详细信息。

**事件名称**：`claude_code.tool_result`

**属性**：`tool_name` 标识工具，`success` 指示成功或失败，`duration_ms` 记录执行时间，`error` 包含错误消息（如果失败），`decision` 记录用户决策。

### API 请求事件

为每个 Claude API 请求生成详细记录。

**事件名称**：`claude_code.api_request`

**属性**：`model` 标识模型，`cost_usd` 估计成本，`duration_ms` 请求持续时间，`input_tokens` 和 `output_tokens` 记录令牌使用，`cache_read_tokens` 和 `cache_creation_tokens` 追踪缓存效率。

### API 错误事件

记录 API 请求失败的情况。

**事件名称**：`claude_code.api_error`

**属性**：`error` 包含错误消息，`status_code` 提供 HTTP 状态码，`attempt` 追踪重试次数。

### 工具决策事件

记录工具权限决策。

**事件名称**：`claude_code.tool_decision`

**属性**：`tool_name` 标识工具，`decision` 记录决策结果，`source` 指明决策来源（config、user_permanent、user_temporary、user_abort 或 user_reject）。

<AdPlaceholder />

## 动态标头配置

### 企业环境设置

对于需要动态身份验证的企业环境，可以配置脚本动态生成标头。

### 配置方法

添加到 `.claude/settings.json`：

```json
{
  "otelHeadersHelper": "/bin/generate_opentelemetry_headers.sh"
}
```

### 脚本要求

脚本必须输出有效的 JSON，包含 HTTP 标头的键值对：

```bash
#!/bin/bash
echo "{\"Authorization\": \"Bearer $(get-token.sh)\", \"X-API-Key\": \"$(get-api-key.sh)\"}"
```

### 刷新行为

标头助手脚本在启动时运行，之后定期运行以支持令牌刷新。默认间隔为 29 分钟，可通过 `CLAUDE_CODE_OTEL_HEADERS_HELPER_DEBOUNCE_MS` 自定义。

<AdPlaceholder />

## 多团队组织支持

### 自定义属性

使用 `OTEL_RESOURCE_ATTRIBUTES` 添加自定义属性区分不同团队或部门：

```bash
export OTEL_RESOURCE_ATTRIBUTES="department=engineering,team.id=platform,cost_center=eng-123"
```

### 格式要求

严格遵循 W3C Baggage 规范：

- 值不能包含空格
- 必须是逗号分隔的键值对
- 仅 US-ASCII 字符（排除控制字符、空格、引号、逗号、分号、反斜杠）
- 特殊字符必须进行百分比编码

```bash
# 无效 - 包含空格
export OTEL_RESOURCE_ATTRIBUTES="org.name=John's Organization"

# 有效 - 使用下划线
export OTEL_RESOURCE_ATTRIBUTES="org.name=Johns_Organization"

# 有效 - 百分比编码
export OTEL_RESOURCE_ATTRIBUTES="org.name=John%27s%20Organization"
```

### 应用场景

这些自定义属性支持：按团队或部门过滤指标、按成本中心跟踪成本、创建特定于团队的仪表板、为特定团队设置警报。

<AdPlaceholder />

## 实用配置示例

### 控制台调试

```bash
export CLAUDE_CODE_ENABLE_TELEMETRY=1
export OTEL_METRICS_EXPORTER=console
export OTEL_METRIC_EXPORT_INTERVAL=1000
```

### OTLP/gRPC 导出

```bash
export CLAUDE_CODE_ENABLE_TELEMETRY=1
export OTEL_METRICS_EXPORTER=otlp
export OTEL_EXPORTER_OTLP_PROTOCOL=grpc
export OTEL_EXPORTER_OTLP_ENDPOINT=http://localhost:4317
```

### Prometheus 导出

```bash
export CLAUDE_CODE_ENABLE_TELEMETRY=1
export OTEL_METRICS_EXPORTER=prometheus
```

### 多导出器组合

```bash
export CLAUDE_CODE_ENABLE_TELEMETRY=1
export OTEL_METRICS_EXPORTER=console,otlp
export OTEL_EXPORTER_OTLP_PROTOCOL=http/json
```

### 仅指标或仅日志

```bash
# 仅指标
export CLAUDE_CODE_ENABLE_TELEMETRY=1
export OTEL_METRICS_EXPORTER=otlp
export OTEL_EXPORTER_OTLP_PROTOCOL=grpc
export OTEL_EXPORTER_OTLP_ENDPOINT=http://localhost:4317

# 仅日志
export CLAUDE_CODE_ENABLE_TELEMETRY=1
export OTEL_LOGS_EXPORTER=otlp
export OTEL_EXPORTER_OTLP_PROTOCOL=grpc
export OTEL_EXPORTER_OTLP_ENDPOINT=http://localhost:4317
```

<AdPlaceholder />

## 指标和事件数据分析

### 使用情况监控

| 指标 | 分析机会 |
|------|----------|
| `claude_code.token.usage` | 按类型、用户、团队或模型分解 |
| `claude_code.session.count` | 跟踪采用和参与度趋势 |
| `claude_code.lines_of_code.count` | 衡量代码产出生产力 |
| `claude_code.commit.count` | 了解版本控制影响 |

### 成本监控

`claude_code.cost.usage` 指标帮助跟踪使用趋势、识别高成本会话。成本指标是近似值，官方计费数据请参考 API 提供商。

### 警报配置

常见警报场景：成本激增、异常的令牌消耗、来自特定用户的高会话量。所有指标支持按多个维度进行分段分析。

### 事件分析应用

**工具使用模式**：分析工具结果事件识别最常用工具、成功率、平均执行时间、错误模式。

**性能监控**：跟踪 API 请求持续时间和工具执行时间，识别性能瓶颈。

<AdPlaceholder />

## 后端选择建议

### 指标后端

**时间序列数据库**（Prometheus）：适合速率计算和聚合指标。

**列式存储**（ClickHouse）：适合复杂查询和唯一用户分析。

**可观测性平台**（Datadog、Honeycomb）：提供高级查询、可视化和警报功能。

### 事件和日志后端

**日志聚合系统**（Elasticsearch、Loki）：适合全文搜索和日志分析。

**可观测性平台**（Datadog、Honeycomb）：支持指标和事件之间的关联分析。

对于需要计算 DAU/WAU/MAU 的组织，请选择支持高效唯一值查询的后端。

## 服务信息

所有指标和事件使用以下资源属性：

- `service.name`：`claude-code`
- `service.version`：当前版本
- `os.type` 和 `os.version`：操作系统信息
- `host.arch`：主机架构
- 仪表名称：`com.anthropic.claude_code`

<AdPlaceholder />

## 安全与隐私

### 隐私保护

- 遥测是可选的，需要显式配置
- 敏感信息（如 API 密钥或文件内容）永远不会包含在指标或事件中
- 用户提示内容默认为已编辑，仅记录提示长度

### 用户提示日志

要启用用户提示日志记录：

```bash
export OTEL_LOG_USER_PROMPTS=1
```

启用此选项会记录完整的用户提示内容，请确保符合组织的数据保护政策。

## 总结

Claude Code 的 OpenTelemetry 集成提供了企业级的监控能力。通过合理配置指标和事件导出，您可以深入了解使用模式、跟踪成本效益、监控性能表现。建议根据组织需求选择合适的监控后端，配置适当的警报机制，并遵循安全最佳实践保护敏感信息。

<AdPlaceholder />
