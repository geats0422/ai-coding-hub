---
title: "并行开发"
description: "了解如何在 Codex 应用中使用 Git 工作树进行并行开发，隔离不同任务的更改"
tool: "codex"
slug: "parallel-development"
---

import { AdPlaceholder } from '@/components/AdPlaceholder'
import { Callout } from '@/components/Callout'

# 工作树

在 Codex 应用中，工作树让 Codex 可以在同一个项目中运行多个独立任务而不会相互干扰。对于 Git 存储库，[自动化](https://developers.openai.com/codex/app/automations)在专用的后台工作树上运行，因此它们不会与您正在进行的工作冲突。在非版本控制项目中，自动化直接在工作目录中运行。您也可以手动在工作树上启动线程。

<AdPlaceholder />

## 什么是工作树

工作树仅适用于作为 Git 存储库一部分的项目，因为它在底层使用 [Git 工作树](https://git-scm.com/docs/git-worktree)。工作树允许您创建仓库的第二个副本（"检出"）。工作树有您仓库中每个文件的自己的副本，但它们都共享关于提交、分支等的相同元数据（`.git` 文件夹）。这允许您并行检出和处理多个分支。

## 术语

- **本地检出**：您创建的仓库。有时在 Codex 应用中简称为 **Local**。
- **工作树**：从您在 Codex 应用中的本地检出的 [Git 工作树](https://git-scm.com/docs/git-worktree)。

## 为什么使用工作树

1. 与 Codex 并行工作而不互相破坏。
2. 开始与您当前工作无关的线程
   - 暂存区以排队您希望 Codex 开始但尚未准备好测试的工作。

## 入门

工作树需要 Git 存储库。确保您选择的项目位于一个 Git 存储库中。

<Callout type="step">
1. 选择"Worktree"

    在新线程视面上，在编辑器下方选择 **Worktree**。可以选择选择[本地环境](https://developers.openai.com/codex/app/local-environments)以运行工作树的设置脚本。

2. 选择起始分支

    在编辑器下方，选择要基于的 Git 分支。这可以是您的 `main` / `master` 分支、功能分支，或带有未提交的本地更改的当前分支。

3. 提交您的提示词

    提交您的任务，Codex 将基于您选择的分支创建一个 Git 工作树。默认情况下，Codex 在 ["detached HEAD"](https://git-scm.com/docs/git-checkout#_detached_head) 中工作。

4. 验证您的更改

    准备好后，根据您的项目和流程，按照以下[验证和推送工作流更改](#验证和推送工作流更改)中的路径之一进行操作。
</Callout>

## 验证和推送工作流更改

工作树的外观和感觉很像您的本地检出。但 **Git 只允许一次在一个地方检出分支**。如果您在工作树上检出了分支，您**不能**同时在本地检出它，反之亦然。

因此，选择您想要如何验证和提交 Codex 在工作树上所做的更改：

1. [专门在工作树上工作](#选项-1-在工作树上工作)。当您可以直接在工作树上验证更改时，此路径效果最好，例如因为您使用[本地环境设置脚本](https://developers.openai.com/codex/app/local-environments)安装了依赖项和工具。
2. [在您的本地检出中工作](#选项-2-在本地检出中工作)。当您想要将更改带回主检出时使用此选项，例如因为您只能运行一个应用程序实例。

### 选项 1：在工作树上工作

如果您想专门在工作树上处理您的更改，使用标头中的 **Create branch here** 按钮将您的工作树转换为分支。

从这里您可以提交您的更改，将分支推送到远程仓库，并在 GitHub 上打开拉取请求。

您可以使用标头中的"打开"按钮在您的工作树中打开您的 IDE，使用集成终端，或从工作树目录中执行任何其他您需要做的事情。

<Callout type="note">
如果您在工作树上创建了分支，您不能在其他任何工作树（包括您的本地检出）中检出它。
</Callout>

*Image Description: 显示分支控件和工作树详细信息的 Worktree 线程视图界面。*

如果您计划继续在此分支上工作，可以[将其添加到侧边栏](#将工作树添加到侧边栏)。否则，完成后存档线程，以便可以删除工作树。

### 选项 2：在本地检出中工作

如果您不想直接在工作树上验证更改，而是想在本地检出上检查它们，请单击标头中的 **Sync with local**。

您将可以选择创建新分支或同步到现有分支。

您可以随时与本地同步。再次单击标头中的 **Sync with local**。从这里，您可以选择同步方向（到本地或从本地）和同步方法：

- **Overwrite**：使目标检出的文件和提交历史与源检出匹配。
- **Apply**：计算自最近共享提交以来的源更改，并将该补丁应用到目标检出，保留目标提交历史，同时带来源代码更改（而不是源提交）。

*Image Description: 显示应用或拉取更改选项的同步工作树对话框界面。*

您可以创建多个工作树并将它们同步到同一个功能分支，以将您的工作拆分为并行线程。

在某些情况下，您的工作树上的更改可能与本地检出上的更改冲突，例如来自测试先前的工作树。在这种情况下，您可以使用 **Overwrite local** 选项来重置先前的更改，并干净地应用您的工作树更改。

因为此过程使用 Git 操作，任何属于 `.gitignore` 文件的文件都不会在同步过程中传输。

## 将工作树添加到侧边栏

如果您选择上述选项一（在工作树上工作），一旦您在工作树上创建了一个分支，标头中会出现一个选项来将工作树添加到侧边栏。这会将工作树提升为永久位置。当您执行此操作时，它永远不会自动删除，您甚至可以从同一个工作树发起新的线程。

## 高级详情

### Codex 如何为您管理工作树

Codex 将在 `$CODEX_HOME/worktrees` 中创建一个工作树。起始提交将是启动线程时选择的分支的 `HEAD` 提交。如果您选择了带有本地更改的分支，未提交的更改也会应用到工作树。工作树**不会**作为分支检出。它将处于 [detached HEAD](https://git-scm.com/docs/git-checkout#_detached_head) 状态。这意味着您可以创建多个工作树而不会污染您的分支。

### 分支限制

假设 Codex 在工作树上完成了一些工作，您选择使用 **Create branch here** 在其上创建 `feature/a` 分支。现在，您想在本地检出上尝试它。如果您尝试检出分支，会收到以下错误：

```
fatal: 'feature/a' is already used by worktree at '<WORKTREE_PATH>'
```

要解决此问题，您需要在工作树上检出另一个分支而不是 `feature/a`。

如果您计划在本地检出分支，请尝试工作流 2（[与本地同步](#选项-2-在本地检出中工作)）。

<ToggleSection title="为什么存在此限制">
Git 防止同一个分支一次在多个工作树中检出，因为分支代表一个单一的可变引用（`refs/heads/<name>`），其含义是工作树的"当前检出状态"。

当检出分支时，Git 将其 HEAD 视为该工作树所有，并期望操作（如提交、重置、变基和合并）以定义良好、序列化的方式推进该引用。允许多个工作树同时检出同一个分支会在更新分支引用方面产生歧义和竞争条件，可能导致丢失提交、不一致索引或不明确的冲突解决。

通过强制执行一个分支一个工作树的规则，Git 保证每个分支都有一个权威的工作副本，同时仍允许其他工作树通过 detached HEAD 或单独的分支安全地引用相同的提交。
</ToggleSection>

## 工作树清理

工作树可能占用大量磁盘空间。每一个都有自己的存储库文件、依赖项、构建缓存等。因此，Codex 应用会尝试将工作树的数量保持在合理限制内。

工作树永远不会被清理，如果：

- 有固定的对话与其关联
- 工作树已添加到侧边栏（见上文）

工作树符合清理条件，当：

- 它超过 4 天
- 您有超过 10 个工作树

当满足任一条件时，Codex 会在您存档线程时自动清理工作树，或在启动应用时发现没有关联线程的工作树时进行清理。

在清理工作树之前，Codex 会保存其工作的快照，您可以在新的工作树中随时恢复。如果您在清理工作树后打开对话，您会看到恢复它的选项。

## 常见问题

<ToggleSection title="我可以控制工作树的创建位置吗？">
目前不能。Codex 在 `$CODEX_HOME/worktrees` 下创建工作树，因此它可以一致地管理它们。
</ToggleSection>

<ToggleSection title="我可以在工作树之间移动会话吗？">
尚不可以。如果您需要更改环境，必须在目标环境中启动新线程并重述提示词。您可以使用编辑器中的向上箭头键尝试恢复提示词。
</ToggleSection>

<ToggleSection title="如果工作树被删除，线程会发生什么？">
即使底层工作树目录被清理，线程也可以保留在您的历史记录中。但是，Codex 会在清理之前保存工作树的快照，并提供在其关联线程重新打开时恢复它的选项。
</ToggleSection>

<AdPlaceholder />
