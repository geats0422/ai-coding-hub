---
title: "Claude Code CLI 自动化运行完全指南：从命令行编程使用 AI"
description: "学习如何使用 Claude Code 的 CLI 模式进行自动化开发。包括结构化输出、工具自动批准、会话继续和脚本集成等高级功能。"
date: "2026-02-10"
tool: "Claude Code"
slug: "cli-automation"
---

import AdPlaceholder from '@/components/AdPlaceholder'

# Claude Code CLI 自动化运行完全指南：从命令行编程使用 AI

Claude Code 不仅可以在交互模式下使用，还支持通过命令行进行编程化调用。CLI 模式让您能够将 Claude 的强大能力集成到脚本、CI/CD 流程和自动化工作流中，大幅提升开发效率。

<AdPlaceholder />

## 前置条件

在学习 CLI 自动化之前，请确保您具备以下条件：

- **Claude Code**：已安装并可运行的 Claude Code
- **命令行环境**：支持 Bash 或 PowerShell 的终端
- **基础脚本知识**：了解基本的 Shell 脚本编写
- **管道和重定向**：理解 Linux/Unix 的基本概念

## 步骤 1：理解 CLI 模式基础

### 步骤 1.1：CLI 模式简介

CLI 模式之前称为"headless mode"，通过 `-p`（或 `--print`）标志来触发。在这种模式下，Claude Code 会非交互式地执行任务并返回结果。

**基本语法：**
```bash
claude -p "您的任务描述" [选项]
```

**简单示例：**
```bash
claude -p "What does the auth module do?"
```

<Note>
CLI 模式下，用户调用的 skills（如 `/commit`）和内置命令不可用。您需要直接描述想要完成的任务。
</Note>

### 步骤 1.2：可用的 CLI 选项

所有 CLI 选项都适用于 `-p` 模式，常用选项包括：

| 选项 | 描述 | 示例 |
|------|------|------|
| `--continue` | 继续对话 | `--continue` |
| `--allowedTools` | 自动批准工具 | `--allowedTools "Read,Edit,Bash"` |
| `--output-format` | 输出格式 | `--output-format json` |
| `--resume` | 恢复特定会话 | `--resume session_id` |

## 步骤 2：获取结构化输出

### 步骤 2.1：输出格式选项

使用 `--output-format` 控制响应的返回方式：

| 格式 | 描述 | 适用场景 |
|------|------|----------|
| `text` | 纯文本输出（默认） | 简单任务、直接查看 |
| `json` | 结构化 JSON | 脚本处理、数据提取 |
| `stream-json` | 流式 JSON | 实时处理、长任务监控 |

**JSON 格式示例：**
```bash
claude -p "Summarize this project" --output-format json
```

<ProTip>
JSON 输出包含结果、会话 ID 和元数据，便于程序化处理。
</ProTip>

### 步骤 2.2：使用 JSON Schema

要获得符合特定架构的输出，使用 `--output-format json` 与 `--json-schema` 结合：

```bash
claude -p "Extract the main function names from auth.py" \
  --output-format json \
  --json-schema '{"type":"object","properties":{"functions":{"type":"array","items":{"type":"string"}}},"required":["functions"]}'
```

**响应结构：**
```json
{
  "result": "文本结果...",
  "session_id": "会话ID",
  "structured_output": {...}
}
```

### 步骤 2.3：使用 jq 解析响应

使用 [jq](https://jqlang.github.io/jq/) 工具解析 JSON 响应：

```bash
# 提取文本结果
claude -p "Summarize this project" --output-format json | jq -r '.result'

# 提取结构化输出
claude -p "Extract function names from auth.py" \
  --output-format json \
  --json-schema '{"type":"object","properties":{"functions":{"type":"array","items":{"type":"string"}}},"required":["functions"]}' \
  | jq '.structured_output'
```

## 步骤 3：流式传输响应

### 步骤 3.1：启用流式输出

使用 `--output-format stream-json` 配合 `--verbose` 和 `--include-partial-messages` 在生成令牌时实时接收：

```bash
claude -p "Explain recursion" --output-format stream-json --verbose --include-partial-messages
```

### 步骤 3.2：过滤和显示流式文本

以下示例仅显示文本增量，过滤其他事件：

```bash
claude -p "Write a poem" --output-format stream-json --verbose --include-partial-messages | \
  jq -rj 'select(.type == "stream_event" and .event.delta.type? == "text_delta") | .event.delta.text'
```

**jq 参数说明：**
- `-r`：输出原始字符串（无引号）
- `-j`：不带换行符连接，连续流式传输

<ProTip>
流式输出非常适合显示进度或处理长文本任务，避免等待完整响应。
</ProTip>

## 步骤 4：自动批准工具

### 步骤 4.1：使用 `--allowedTools` 标志

使用 `--allowedTools` 让 Claude 使用某些工具而无需每次请求权限：

```bash
claude -p "Run the test suite and fix any failures" \
  --allowedTools "Bash,Read,Edit"
```

### 步骤 4.2：精细的工具控制

使用权限规则语法进行更细粒度的控制：

```bash
claude -p "Look at my staged changes and create an appropriate commit" \
  --allowedTools "Bash(git diff *),Bash(git log *),Bash(git status *),Bash(git commit *)"
```

<Note>
尾部的 ` *` 启用前缀匹配，因此 `Bash(git diff *)` 允许任何以 `git diff` 开头的命令。空格在 `*` 之前很重要。
</Note>

### 步骤 4.3：常见的自动化场景

**运行测试并修复：**
```bash
claude -p "Run the test suite and fix any failures" \
  --allowedTools "Bash,Read,Edit"
```

**代码审查并生成报告：**
```bash
claude -p "Review the changes and generate a report" \
  --allowedTools "Bash(git diff *),Bash(git status *),Read"
```

<ProTip>
合理使用自动批准可以大幅提高自动化效率，但要注意安全风险。
</ProTip>

## 步骤 5：创建自动化提交

### 步骤 5.1：Git 提交工作流

以下示例审查暂存的更改并创建具有适当消息的提交：

```bash
claude -p "Look at my staged changes and create an appropriate commit" \
  --allowedTools "Bash(git diff *),Bash(git log *),Bash(git status *),Bash(git commit *)"
```

### 步骤 5.2：结合 GitHub CLI

结合 GitHub CLI 使用：

```bash
gh pr diff "$1" | claude -p \
  --append-system-prompt "You are a security engineer. Review for vulnerabilities." \
  --output-format json
```

## 步骤 6：自定义系统提示

### 步骤 6.1：追加系统提示

使用 `--append-system-prompt` 添加指令同时保持默认行为：

```bash
gh pr diff "$1" | claude -p \
  --append-system-prompt "You are a security engineer. Review for vulnerabilities." \
  --output-format json
```

### 步骤 6.2：完全替换提示

使用 `--system-prompt` 完全替换默认提示（谨慎使用）：

```bash
claude -p "执行特定任务" \
  --system-prompt "你是一个专业的代码审查助手..."
```

<ProTip>
追加提示比完全替换更安全，可以保留 Claude Code 的核心功能。
</ProTip>

## 步骤 7：继续和恢复对话

### 步骤 7.1：继续最近的对话

使用 `--continue` 继续最近的对话：

```bash
# 首次请求
claude -p "Review this codebase for performance issues"

# 继续对话
claude -p "Now focus on the database queries" --continue
claude -p "Generate a summary of all issues found" --continue
```

### 步骤 7.2：恢复特定会话

如果您运行多个对话，需要捕获会话 ID 以恢复特定对话：

```bash
# 捕获会话 ID
session_id=$(claude -p "Start a review" --output-format json | jq -r '.session_id')

# 恢复特定对话
claude -p "Continue that review" --resume "$session_id"
```

### 步骤 7.3：处理复杂的多步骤任务

```bash
# 步骤 1：分析代码库
session_id=$(claude -p "分析这个项目的架构" --output-format json | jq -r '.session_id')

# 步骤 2：深入特定模块
claude -p "现在深入分析认证模块" --resume "$session_id"

# 步骤 3：生成报告
claude -p "生成完整的分析报告" --resume "$session_id" > report.md
```

<ProTip>
会话 ID 是长期任务的利器，让多步骤分析变得井然有序。
</ProTip>

## 步骤 8：集成到 CI/CD

### 步骤 8.1：基本的 CI 集成

在 CI 脚本中使用：

```bash
#!/bin/bash
# CI 脚本示例

# 运行测试
claude -p "Run the test suite and output results" \
  --allowedTools "Bash,Read,Edit" \
  --output-format json | tee test_results.json
```

### 步骤 8.2：自动化代码审查

```bash
#!/bin/bash
# 预提交审查脚本

claude -p "审查暂存的更改是否有问题" \
  --allowedTools "Bash(git diff *),Bash(git status *)" \
  --output-format json > review_result.json

# 检查结果
if jq -e '.result | contains("critical")' review_result.json; then
  echo "发现严重问题，请检查"
  exit 1
fi
```

### 步骤 8.3：自动化文档更新

```bash
#!/bin/bash
# 更新文档脚本

claude -p "更新 README.md，包含新的功能说明" \
  --allowedTools "Read,Edit" \
  --output-format json
```

## 专业提示

### 提示 1：善用结构化输出

在脚本中处理 Claude 的响应时：

```bash
# 获取会话 ID 用于后续操作
session_id=$(claude -p "开始分析" --output-format json | jq -r '.session_id')

# 获取结果用于日志
result=$(claude -p "生成摘要" --output-format json | jq -r '.result')
echo "$result" >> log.txt
```

<ProTip>
将结果存储到变量中，便于后续处理和日志记录。
</ProTip>

### 提示 2：组合多个工具

在复杂任务中组合使用：

```bash
# 完整的代码审查流程
claude -p "审查代码并修复发现的问题" \
  --allowedTools "Bash(git diff *),Bash(git status *),Read,Edit" \
  --output-format json \
  --continue
```

### 提示 3：错误处理

在脚本中处理可能的错误：

```bash
#!/bin/bash

result=$(claude -p "执行任务" --output-format json 2>&1)
exit_code=$?

if [ $exit_code -ne 0 ]; then
  echo "Claude 执行失败: $result"
  exit 1
fi

echo "成功: $result"
```

### 提示 4：性能优化

对于频繁调用：

- 复用会话（使用 `--continue` 或 `--resume`）
- 减少不必要的工具批准
- 使用流式输出处理长响应

<ProTip>
在循环中调用 CLI 时，复用会话可以显著减少延迟和令牌消耗。
</ProTip>

## 常见问题排查

### 问题 1：工具不被批准

**解决方案：**
1. 检查 `--allowedTools` 语法是否正确
2. 确认使用的工具名称正确
3. 验证权限规则语法

### 问题 2：JSON 解析失败

**解决方案：**
1. 检查 JSON 输出是否完整
2. 使用 `jq -r` 处理 raw 字符串
3. 验证 jq 语法

### 问题 3：会话无法继续

**解决方案：**
1. 确认会话 ID 正确
2. 检查会话是否过期
3. 验证是否在同一个项目目录

### 问题 4：输出格式不匹配

**解决方案：**
1. 确认 `--output-format` 参数正确
2. 检查 JSON Schema 是否有效
3. 验证响应是否符合预期格式

## 结论

CLI 模式让 Claude Code 成为强大的自动化工具。通过本指南的学习，您已经掌握了：

- ✅ CLI 模式的基本使用方法
- ✅ 结构化输出和 JSON Schema
- ✅ 流式传输响应的技巧
- ✅ 工具自动批准机制
- ✅ 对话继续和恢复功能
- ✅ CI/CD 集成方法

<ProTip>
将 CLI 模式集成到您的工作流中，可以让日常开发任务自动化，大幅提升效率。
</ProTip>

<AdPlaceholder />
