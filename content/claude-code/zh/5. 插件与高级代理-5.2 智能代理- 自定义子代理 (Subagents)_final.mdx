---
title: "Claude Code 子代理完全指南：创建与使用自定义 Subagents"
description: "学习如何在 Claude Code 中创建和使用专门的子代理，包括内置代理介绍、配置文件案、工具控制、持久内存管理，以及与主对话协同的高级模式。"
date: "2026-02-10"
tool: "Claude Code"
slug: "custom-subagents"
---

import AdPlaceholder from '@/components/AdPlaceholder'

# Claude Code 子代理完全指南

子代理（Subagents）是 Claude Code 中处理特定任务的专门 AI 助手，每个子代理在独立的上下文窗口中运行，拥有自定义的系统提示、特定的工具访问权限和独立的权限设置。当 Claude 遇到与子代理描述相匹配的任务时，会自动委托给该子代理进行独立工作。这种机制帮助您保留主对话上下文、强制执行工具约束、实现跨项目配置重用，以及通过选择更快速的模型来控制成本。

<AdPlaceholder />

## 前置条件

在开始使用子代理之前，请确保满足以下条件：

- 熟悉 Claude Code 的基本使用方法
- 了解 YAML frontmatter 的基本语法
- 具备命令行操作和脚本编写经验
- 理解工具权限和上下文管理概念

## 内置子代理

Claude Code 提供了几个内置子代理，Claude 在适当时会自动调用。

### Explore 子代理

Explore 是一个快速、只读的代理，专门针对代码库搜索和分析进行了优化。使用 Haiku 模型提供低延迟响应，工具限制为只读工具（拒绝 Write 和 Edit 访问），适用于文件发现、代码搜索和代码库探索场景。当 Claude 需要搜索或理解代码库而不进行更改时，会自动委托给 Explore 代理。

### Plan 子代理

Plan 是一个研究代理，在计划模式期间使用，用于在呈现计划之前收集上下文。它继承自主对话的模型，使用只读工具拒绝文件修改权限。当您处于计划模式且 Claude 需要理解代码库时，会将研究委托给 Plan 子代理，防止无限嵌套的同时收集必要上下文。

### General-purpose 子代理

General-purpose 能够处理需要探索和操作的复杂多步骤任务。它继承主对话的模型，可以使用所有工具，适用于复杂研究、多步骤操作和代码修改场景。当任务需要探索和修改、复杂推理来解释结果或多个相关步骤时，Claude 会委托给此代理。

<AdPlaceholder />

## 快速开始：创建第一个子代理

子代理通过带有 YAML frontmatter 的 Markdown 文件定义，可以使用 `/agents` 命令交互式创建。

### 步骤 1：打开子代理界面

在 Claude Code 中运行 `/agents` 命令打开子代理管理界面。

### 步骤 2：创建新的子代理

选择创建新代理，然后选择用户级范围。这会将子代理保存到 `~/.claude/agents/`，使其在所有项目中可用。

### 步骤 3：使用 Claude 生成

选择使用 Claude 生成，出现提示时描述子代理的功能：

```
A code improvement agent that scans files and suggestions improvements
for readability, performance, and best practices. It should explain
each issue, show the current code, and provide an improved version.
```

Claude 会生成系统提示和配置，可以按 `e` 在编辑器中打开进行自定义。

### 步骤 4：选择工具

根据子代理的用途选择工具。对于只读审查者，取消选择除只读工具之外的所有内容。如果保持所有工具被选中，子代理会继承主对话可用的所有工具。

### 步骤 5：选择模型

选择子代理使用的模型。Sonnet 在分析能力和速度之间取得平衡，适合大多数代码分析任务。

### 步骤 6：保存并测试

保存子代理后立即可用，尝试使用：

```
Use the code-improver agent to suggest improvements in this project
```

Claude 会委托给新子代理，扫描代码库并返回改进建议。

<AdPlaceholder />

## 配置子代理

### 子代理范围

子代理文件根据范围存储在不同位置，当多个子代理共享相同名称时，优先级较高的位置获胜：

| 位置 | 范围 | 优先级 |
|------|------|--------|
| `--agents` CLI 标志 | 当前会话 | 1（最高） |
| `.claude/agents/` | 当前项目 | 2 |
| `~/.claude/agents/` | 所有项目 | 3 |
| 插件的 `agents/` 目录 | 启用插件的位置 | 4（最低） |

项目子代理非常适合特定于代码库的用途，检入版本控制后团队可以协作使用和改进。用户子代理在所有项目中可用，是个人工具集的理想选择。

### CLI 定义的子代理

CLI 定义的子代理在启动时作为 JSON 传递，仅存在于当前会话中，不会保存到磁盘：

```bash
claude --agents '{
  "code-reviewer": {
    "description": "Expert code reviewer. Use proactively after code changes.",
    "prompt": "You are a senior code reviewer. Focus on code quality, security, and best practices.",
    "tools": ["Read", "Grep", "Glob", "Bash"],
    "model": "sonnet"
  }
}'
```

### 编写子代理文件

子代理文件使用 YAML frontmatter 配置，Markdown 正文作为系统提示：

```markdown
---
name: code-reviewer
description: Reviews code for quality and best practices
tools: Read, Glob, Grep
model: sonnet
---

You are a code reviewer. When invoked, analyze the code and provide
specific, actionable feedback on quality, security, and best practices.
```

### 支持的 Frontmatter 字段

| 字段 | 必需 | 描述 |
|------|------|------|
| `name` | 是 | 唯一标识符 |
| `description` | 是 | Claude 何时应委托 |
| `tools` | 否 | 可用工具列表 |
| `disallowedTools` | 否 | 要拒绝的工具 |
| `model` | 否 | 使用的模型 |
| `permissionMode` | 否 | 权限模式 |
| `skills` | 否 | 预加载的技能 |
| `hooks` | 否 | 生命周期钩子 |
| `memory` | 否 | 持久内存范围 |

<AdPlaceholder />

## 控制子代理能力

### 工具访问控制

子代理可以使用 Claude Code 的任何内部工具，默认继承主对话的所有工具。使用 `tools` 字段限制允许的工具，或使用 `disallowedTools` 字段排除特定工具：

```yaml
---
name: safe-researcher
description: Research agent with restricted capabilities
tools: Read, Grep, Glob, Bash
disallowedTools: Write, Edit
---
```

### 权限模式

`permissionMode` 字段控制子代理处理权限提示的方式：

| 模式 | 行为 |
|------|------|
| `default` | 标准权限检查和提示 |
| `acceptEdits` | 自动接受文件编辑 |
| `dontAsk` | 自动拒绝权限提示 |
| `bypassPermissions` | 跳过所有权限检查 |
| `plan` | 计划模式（只读探索） |

谨慎使用 `bypassPermissions`，它允许子代理在没有批准的情况下执行任何操作。

### 技能预加载

使用 `skills` 字段在启动时将技能内容注入到子代理的上下文中：

```yaml
---
name: api-developer
description: Implement API endpoints following team conventions
skills:
  - api-conventions
  - error-handling-patterns
---

Implement API endpoints. Follow the conventions from the preloaded skills.
```

子代理不继承来自父对话的技能，必须明确列出。

<AdPlaceholder />

## 持久内存管理

### 启用持久内存

`memory` 字段为子代理提供跨对话存活的持久目录：

```yaml
---
name: code-reviewer
description: Reviews code for quality and best practices
memory: user
---

You are a code reviewer. Update your memory with patterns and conventions you discover.
```

### 内存范围选择

| 范围 | 位置 | 用途 |
|------|------|------|
| `user` | ~/.claude/agent-memory/ | 所有项目共享的知识 |
| `project` | .claude/agent-memory/ | 特定项目并可版本控制 |
| `local` | .claude/agent-memory-local/ | 项目特定但不检入 |

### 内存使用最佳实践

要求子代理在开始工作前查阅内存，并在完成任务后更新内存。在子代理的 markdown 文件中包含内存维护说明，主动构建知识库。user 是推荐的默认范围，当知识仅与特定代码库相关时使用 project 或 local。

<AdPlaceholder />

## 使用钩子的条件控制

### 动态工具验证

使用 `PreToolUse` 钩子在执行前验证操作，实现比工具字段更精细的控制：

```yaml
---
name: db-reader
description: Execute read-only database queries
tools: Bash
hooks:
  PreToolUse:
    - matcher: "Bash"
      hooks:
        - type: command
          command: "./scripts/validate-readonly-query.sh"
---
```

验证脚本通过 stdin 接收 JSON 输入，提取命令并检查是否为写操作：

```bash
#!/bin/bash
INPUT=$(cat)
COMMAND=$(echo "$INPUT" | jq -r '.tool_input.command // empty')

if echo "$COMMAND" | grep -iE '\b(INSERT|UPDATE|DELETE|DROP)\b' > /dev/null; then
  echo "Blocked: Only SELECT queries are allowed" >&2
  exit 2
fi

exit 0
```

退出代码 2 阻止操作并将错误消息返回给 Claude。

### 子代理生命周期钩子

子代理 frontmatter 中的 hooks 在特定子代理活动时运行：

| 事件 | 触发时机 |
|------|----------|
| `PreToolUse` | 使用工具之前 |
| `PostToolUse` | 使用工具之后 |
| `Stop` | 子代理完成时 |

<AdPlaceholder />

## 子代理使用模式

### 理解自动委托

Claude 根据任务描述、子代理配置中的 description 字段和当前上下文自动委托。在 description 中包含"use proactively"等短语鼓励主动委托，也可以明确请求特定子代理。

### 前台与后台运行

**前台子代理**阻塞主对话直到完成，权限提示和澄清问题会传递给您。**后台子代理**在您继续工作时并发运行，需要预先授予工具权限。如果后台子代理因缺少权限失败，可以恢复在前台重试。

### 隔离高容量操作

子代理最有效的用途之一是隔离产生大量输出的操作。运行测试、获取文档或处理日志文件会消耗大量上下文，委托给子代理后详细输出保留在子代理上下文中，只有相关摘要返回主对话。

### 链接子代理

对于多步骤工作流，可以要求 Claude 按顺序使用子代理：

```
Use the code-reviewer subagent to find performance issues, then use the optimizer subagent to fix them
```

每个子代理完成其任务并将结果返回 Claude，然后传递给下一个。

### 主对话与子代理的选择

使用**主对话**的情况：任务需要频繁来回或迭代细化；多个阶段共享重要上下文；正在进行快速有针对性的更改；延迟很重要。

使用**子代理**的情况：任务产生不需要在主上下文中的详细输出；想强制执行特定的工具限制或权限；工作是自包含的可以返回摘要。

<AdPlaceholder />

## 恢复子代理

每个子代理调用都会创建具有新鲜上下文的新实例。要继续现有子代理的工作而不是重新开始，要求 Claude 恢复它。恢复的子代理保留完整的对话历史，包括所有以前的工具调用、结果和推理，从停止的地方继续而不是从头开始。

当子代理完成时，Claude 接收其代理 ID。要求继续之前的工作：

```
Use the code-reviewer subagent to review the authentication module
[Agent completes]

Continue that code review and now analyze the authorization logic
[Claude resumes the subagent with full context]
```

子代理成绩单独立于主对话持久化：主对话压缩不影响子代理成绩单；会话持久化使子代理可以在重启后恢复；成绩单根据 cleanupPeriodDays 设置进行清理。

<AdPlaceholder />

## 示例子代理

### 代码审查者

专注的只读子代理，审查代码而不修改：

```markdown
---
name: code-reviewer
description: Expert code review specialist. Proactively reviews code for quality, security, and maintainability.
tools: Read, Grep, Glob, Bash
model: inherit
---

You are a senior code reviewer ensuring high standards of code quality and security.

When invoked:
1. Run git diff to see recent changes
2. Focus on modified files
3. Begin review immediately

Review checklist:
- Code is clear and readable
- Proper error handling
- No exposed secrets or API keys
- Input validation implemented
- Good test coverage

Provide feedback organized by priority: Critical issues, Warnings, Suggestions.
```

### 调试器

可以分析并修复问题的子代理：

```markdown
---
name: debugger
description: Debugging specialist for errors, test failures, and unexpected behavior.
tools: Read, Edit, Bash, Grep, Glob
---

You are an expert debugger specializing in root cause analysis.

When invoked:
1. Capture error message and stack trace
2. Identify reproduction steps
3. Isolate the failure location
4. Implement minimal fix
5. Verify solution works

For each issue, provide: root cause explanation, evidence, specific fix, testing approach, and prevention recommendations.
```

### 数据库查询验证器

允许 Bash 访问但验证仅允许只读 SQL 查询的子代理：

```markdown
---
name: db-reader
description: Execute read-only database queries for data analysis and reports.
tools: Bash
hooks:
  PreToolUse:
    - matcher: "Bash"
      hooks:
        - type: command
          command: "./scripts/validate-readonly-query.sh"
---

You are a database analyst with read-only access. Execute SELECT queries to answer questions about the data.

You cannot modify data. If asked to INSERT, UPDATE, DELETE, or modify schema, explain that you only have read access.
```

<AdPlaceholder />

## 禁用子代理

通过将子代理添加到设置中的 deny 数组来防止 Claude 使用特定子代理：

```json
{
  "permissions": {
    "deny": ["Task(Explore)", "Task(my-custom-agent)"]
  }
}
```

或者使用 CLI 标志：

```bash
claude --disallowedTools "Task(Explore)"
```

## 总结

子代理系统为 Claude Code 提供了强大的任务委托和上下文隔离能力。通过创建专注的子代理，您可以强制执行工具限制、保留上下文、实现跨项目重用，以及通过选择适当模型来控制成本。建议从简单的只读子代理开始，逐步探索持久内存、钩子验证等高级功能，最终构建适合您工作流程的子代理工具集。

<AdPlaceholder />
