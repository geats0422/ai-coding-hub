---
title: "钩子脚本（Hooks）"
description: "了解 Gemini CLI 的挂钩系统，并了解如何在代理循环中的特定点注入自定义逻辑和验证。"
tool: "gemini-cli"
slug: "hooks"
locale: "zh"
---

import { AdPlaceholder } from '@/components/AdPlaceholder'
import { Callout } from '@/components/Callout'

# Gemini CLI 挂钩

挂钩是 Gemini CLI 在特定点执行的脚本或程序
代理循环，允许您拦截和自定义行为而无需修改
CLI 的源代码。

## 什么是钩子？

钩子作为代理循环的一部分同步运行——当钩子事件触发时，
Gemini CLI 在继续之前等待所有匹配的挂钩完成。

使用钩子，您可以：- **添加上下文：** 在之前注入相关信息（如 git 历史记录）
  模型处理请求。
- **验证操作：**审查工具参数并阻止潜在危险
  操作。
- **执行策略：**实施安全扫描和合规性检查。
- **记录交互：** 跟踪工具使用情况和模型响应以进行审核。
- **优化行为：**动态过滤可用工具或调整模型
  参数。

<AdPlaceholder />

### 开始使用- **[Writing hooks guide](/docs/hooks/writing-hooks)**：创建教程
  您的第一个带有全面示例的钩子。
- **[Best practices](/docs/hooks/best-practices)**：安全指南，
  性能和调试。
- **[Hooks reference](/docs/hooks/reference)**：权威的技术
  I/O 模式和退出代码的规范。

## 核心概念

### 挂钩事件

挂钩由 Gemini CLI 生命周期中的特定事件触发。|活动 |当它开火时 |影响 |常见用例 |
| -------------------- | ---------------------------------------------------------- | ---------------------- | -------------------------------------------------------- |
| `SessionStart` |会话开始时（启动、恢复、清除）|注入上下文 |初始化资源，加载上下文 |
| `SessionEnd` |当会话结束时（退出、清除）|咨询 |清理，保存状态|
| `BeforeAgent` |用户提交提示后，规划之前 |块转弯/上下文|添加上下文、验证提示、阻止轮流 |
| `AfterAgent` |当代理循环结束时 |重试/停止|查看输出、强制重试或停止执行 |
| `BeforeModel` |在向 LLM 发送请求之前 |块转弯/模拟|修改提示、交换模型、模拟响应 |
| `AfterModel` |收到LLM回复后|块转动/编辑|过滤/编辑响应，记录交互 |
| `BeforeToolSelection` | LLM选择工具之前 |过滤工具|筛选可用工具，优化选择 |
| `BeforeTool` |在工具执行之前 |块工具/重写|验证参数，阻止危险操作 |
| `AfterTool` |工具执行后 |块结果/上下文 |处理结果、运行测试、隐藏结果 |
| `PreCompress` |上下文压缩之前 |咨询 |保存状态，通知用户|
| `Notification` |当系统通知发生时 |咨询 |转发到桌面警报、日志记录 |### 全球机制

了解这些核心原则对于构建强大的钩子至关重要。

#### 严格的 JSON 要求（“黄金法则”）

钩子通过`stdin`（输入）和`stdout`（输出）进行通信。

1. **必须保持沉默**：您的脚本**不得**将任何纯文本打印到
   `stdout` 除了最终的 JSON 对象。 **即使是单个`echo`或`print`
   在 JSON 之前调用将中断解析。**
2. **污染=失败**：如果`stdout`包含非JSON文本，解析将
   失败。 CLI 将默认为“允许”并将整个输出视为
   `systemMessage`。
3. **通过 Stderr 调试**：使用 `stderr` 进行 **所有** 日志记录和调试（例如，
   `echo "debug" >&2`）。 Gemini CLI 捕获`stderr` 但从未尝试解析
   它作为 JSON。

#### 退出代码Gemini CLI 使用退出代码来确定挂钩的高级结果
执行：|退出代码 |标签|行为影响|
| --------- | ---------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **0** | **成功** | `stdout` 被解析为 JSON。 **所有逻辑的首选代码**，包括有意的块（例如，`{"decision": "deny"}`）。                                               |
| **2** | **系统块** | **关键块**。目标操作（刀具、转动或停止）被中止。 `stderr` 用作拒绝原因。严重程度高；用于安全停止或脚本失败。 |
| **其他** | **警告** |非致命故障。将显示警告，但交互将使用原始参数继续进行。                                                                               |#### 匹配器

您可以使用以下命令过滤哪些特定工具或触发器触发您的钩子
`matcher` 字段。

- **工具事件**（`BeforeTool`、`AfterTool`）：匹配器是**常规的
  表达式**。 （例如`"write_.*"`）。
- **生命周期事件**：匹配器是**精确字符串**。 （例如，`"startup"`）。
- **通配符**：`"*"` 或 `""`（空字符串）匹配所有出现的情况。

## 配置

钩子在`settings.json`中配置。 Gemini CLI 合并配置
多个层按以下优先级顺序（从最高到最低）：

1. **项目设置**：当前目录下的`.Gemini/settings.json`。
2. **用户设置**：`~/.Gemini/settings.json`。
3. **系统设置**：`/etc/Gemini-cli/settings.json`。
4. **扩展**：由已安装的扩展定义的挂钩。### 配置架构
```
jso
n
{
  "hooks": {
    "BeforeTool": [
      {
        "matcher": "write_file|replace",
        "hooks": [
          {
            "name": "security-check",
            "type": "command",
            "command": "$GEMINI_PROJECT_DIR/.gemini/hooks/security.sh",
            "timeout": 5000
          }
        ]
      }
    ]
  }
}
```
#### 钩子配置字段|领域|类型 |必填|描述 |
| :------------ | :-----| :-------- | ：-------------------------------------------------------------------------------- |
| `type` |字符串| **是** |执行引擎。目前仅支持`"command"`。       |
| `command` |字符串| **是\*** |要执行的 shell 命令。 （`type` 为`"command"` 时必需）。 |
| `name` |字符串|没有 |用于识别日志和 CLI 命令中的挂钩的友好名称。   |
| `timeout` |数量 |没有 |执行超时以毫秒为单位（默认值：60000）。                  |
| `description` |字符串|没有 |钩子用途的简要说明。                           |

---### 环境变量

挂钩是在经过净化的环境中执行的。

- `GEMINI_PROJECT_DIR`：项目根目录的绝对路径。
- `GEMINI_SESSION_ID`：当前会话的唯一ID。
- `GEMINI_CWD`：当前工作目录。
- `CLAUDE_PROJECT_DIR`：（别名）提供兼容性。

## 安全与风险

<Callout type="warning">
警告：挂钩会使用您的用户权限执行任意代码。由
配置挂钩，您允许脚本在您的计算机上运行 shell 命令
机。
</Callout>

**项目级挂钩**在打开不受信任的项目时风险特别大。
Gemini CLI **指纹**项目挂钩。如果钩子的名称或命令发生变化
（例如，通过`git pull`），它被视为**新的、不受信任的钩子**，您将
在执行之前收到警告。参见[Security Considerations](/docs/hooks/best-practices#using-hooks-securely)
详细的威胁模型。

## 管理钩子

使用 CLI 命令来管理挂钩，无需手动编辑 JSON：

- **查看挂钩：** `/hooks panel`
- **启用/禁用全部：** `/hooks enable-all` 或 `/hooks disable-all`
- **切换个人：** `/hooks enable <name>` 或 `/hooks disable <name>`

<AdPlaceholder />
